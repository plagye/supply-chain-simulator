# Supply Chain Simulator

A discrete-event supply chain simulation for **SkyForge**, a fictional manufacturer of commercial drones. The simulator models demand, production (BOM and jobs), procurement, shipments, invoicing, and delivery across a single plant, multiple distribution centers, and several suppliers and customers. It can run as a one-shot simulation (fixed ticks) or as a **continuous service** with a **live read-only HTTP API** for dashboards and integrations.

---

## Business Scenario

**SkyForge** produces **10 drone models** (D-101 through D-303) at one **plant** (FAC-001, Chicago). Products share **10 common parts** (P-001..P-010) sourced from **4 suppliers** in China, Germany, and the USA. Finished goods are shipped to **4 distribution centers** (NA: Detroit, Dallas; EMEA: Rotterdam; APAC: Singapore), and **15 customers** across segments (Retail, Logistics, Agriculture, Government) place orders that are fulfilled from inventory or backordered.

- **Demand:** Random sales orders by product; higher probability during business hours; optional bulk orders and promotions.
- **Production:** Jobs consume parts per BOM; duration and lead times are configurable; quality reject rates apply.
- **Procurement:** Purchase orders to suppliers with base lead times; partial shipments and quality rejects.
- **Delivery:** Loads move from plant to DCs by **location code** (e.g. USA_CHI → USA_DET); delivery events and optional transit delay.
- **Finance:** Invoicing and payments with configurable terms and late-payment probability.
- **Planning:** Optional demand forecast, S&OP snapshots, and cost drift / seasonality for realism.

The **live API** (when running in service mode) exposes current status, inventory (parts and products), backorders, and deliveries so external systems can “call and get values” without building a UI in this repo.

---

## Key Parameters of the Situation

| Dimension | Count / Scope | Details |
|-----------|----------------|---------|
| **Parts** | 10 | P-001..P-010: Frame-Light/Heavy, Motor-Std/Pro, Propeller-Set, Battery-5Ah/10Ah, Flight-Controller, Nav-GPS, Payload-Interface. See `data/parts.json`. |
| **Products** | 10 | D-101 Sparrow-S1, D-102 Sparrow-Pro, D-103 Falcon-X, D-201 Courier-M, D-202 Courier-L, D-203 Surveyor-300, D-204 Surveyor-500, D-301 Titan-Hauler, D-302 Agri-Sprayer, D-303 Sky-Crane. Generated by `scripts/generate_products.py` → `data/products.json`. |
| **BOM** | Multi-product | Each product uses a subset of the 10 parts; structure in `data/bom.json` as `{ "products": { "D-101": { "bom": [...] }, ... } }`. |
| **Suppliers** | 4 | SUP-001 VoltStream Tech (China), SUP-002 CarbonFiber Works (Germany), SUP-003 LogicCore Systems (USA), SUP-004 OmniMount Solutions (USA). Reliability, risk, and price multipliers in `data/suppliers.json`. |
| **Facilities** | 5 | FAC-001 SkyForge HQ (plant, Chicago, `USA_CHI`); dist_na_01 (Detroit, `USA_DET`), dist_na_02 (Dallas, `USA_DAL`), dist_emea_01 (Rotterdam, `NLD_RTM`), dist_apac_01 (Singapore, `SGP_SIN`). |
| **Routes** | Inbound + outbound | Inbound: plant → suppliers (China, Germany, USA). Outbound: plant → each DC by `origin_location_code` / `destination_location_code`. |
| **Customers** | 15 | 4 segments; each has `destination_facility_id` and `delivery_location_code` for code-based delivery. |

All IDs (parts, products, facilities, routes, customers) are fixed by the generators so the engine and API are deterministic for a given seed.

---

## Simulation Engine Parameters

Controlled via `config.json` under `simulate.engine` / `run-service.engine` (and `all.engine`). Key groups:

| Area | Parameters | Meaning |
|------|------------|---------|
| **Demand** | `demand_probability_base`, `demand_probability_business_hours`, `business_hours_start`/`_end` | Base and business-hour order probabilities (per tick). |
| | `bulk_order_probability`, `bulk_order_qty_min`/`_max`, `normal_order_qty_min`/`_max` | Bulk vs normal order sizes. |
| **Production** | `production_duration_hours_min`/`_max` | Job duration range. |
| **Procurement** | `base_lead_time_hours_min`/`_max` | Supplier lead time range. |
| | `partial_shipment_probability`, `partial_shipment_min_pct`/`_max_pct` | Partial deliveries. |
| | `quality_reject_rate_min`/`_max` | Incoming quality rejection. |
| **Data / cost** | `data_corruption_enabled`, `data_corruption_probability` | Optional bad records for ETL testing. |
| | `cost_drift_enabled`, `cost_drift_daily_pct`, `cost_drift_max_pct` | Daily cost drift cap. |
| **Seasonality** | `seasonality_enabled`, `demand_seasonality_strength`, `supplier_seasonality_strength` | Demand and supply seasonality. |
| **Invoicing** | `invoice_enabled`, `invoice_payment_days_min`/`_max`, `payment_late_probability`, `payment_late_days_extra` | Payment terms and late payments. |
| **Pricing** | `default_unit_price` | Default product price (e.g. 1250). |
| **Planning** | `forecast_enabled`, `forecast_horizon_days`, `forecast_window_days`, `requirements_lead_time_days` | Demand forecast and planning horizon. |
| | `sop_enabled`, `sop_frequency` | S&OP snapshot frequency (e.g. monthly). |
| **Promo** | `promo_enabled`, `promo_probability`, `promo_duration_days`, `promo_demand_multiplier_min`/`_max` | Promotional demand spikes. |
| **Delivery** | `delivery_enabled`, `delivery_transit_delay_max_hours` | Delivery events and max transit delay. |

Exact keys and defaults are in `config.json`; the engine reads the whole `engine` block.

---

## Quick Start

```bash
pip install -r requirements.txt
python main.py generate
python main.py simulate --ticks 720
```

Events are written to date-partitioned JSONL under `data/events/` (e.g. `YYYY-MM-DD.jsonl`).

---

## Commands

| Command | Description |
|--------|-------------|
| `python main.py generate [--seed 42]` | Generate all master data (suppliers, parts, products, BOM, facilities, routes, customers, inventory, production_schedule). |
| `python main.py simulate [--ticks 720] [--seed 42]` | Run simulation for a fixed number of hourly ticks. |
| `python main.py all [--ticks 720] [--seed 42]` | Generate then simulate. |
| `python main.py generate-history --years 3 [--seed 42]` | Generate 1–3 years of history to `data/events/history.jsonl`. |
| `python main.py run-service [--tick-interval 5] [--resume \| --fresh]` | Run as continuous service (state in PostgreSQL optional); **live API** available when enabled in config. |

---

## Live API (run-service only)

When `run-service` is used, a read-only HTTP API serves current simulation state so you can **call and get values** (e.g. for a dashboard or integration). No UI is built in this repo.

- **Base URL:** `http://<host>:<port>` (default from config: `http://127.0.0.1:8010`).
- **Binding:** In `config.json` under `run-service`, set `api_host` to `0.0.0.0` to listen on all interfaces (e.g. on an Ubuntu server); then call the API using the server’s IP, e.g. `http://<server-ip>:8010/status`.

### Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | `/status` | Simulation status: `current_time`, `tick_count`, `running`. |
| GET | `/inventory` | All current inventory (parts + products). |
| GET | `/inventory/parts` | Parts only (P-001..P-010). |
| GET | `/inventory/products` | Finished products only (D-101..D-303). |
| GET | `/inventory/{id}` | Single item by part_id or product_id (404 if missing). |
| GET | `/backorders` | Pending backorders. |
| GET | `/deliveries` | Pending deliveries (loads in transit). |

### Example

```bash
curl http://127.0.0.1:8010/status
curl http://127.0.0.1:8010/inventory
curl http://127.0.0.1:8010/inventory/parts
curl http://127.0.0.1:8010/backorders
curl http://127.0.0.1:8010/deliveries
```

---

## Config

- **run-service:** `tick_interval`, `seed`, `api_host` (default `127.0.0.1`), `api_port` (default `8010`), `api_enabled` (default `true`).
- **simulate / run-service / all:** Full `engine` block for demand, production, suppliers, invoicing, forecast, S&OP, promo, delivery, data_corruption, cost_drift, seasonality. See `config.json`.

---

## Output Files

- **Master data:** `data/suppliers.json`, `parts.json`, `products.json` (from `generate_products.py`), `bom.json`, `customers.json`, `facilities.json`, `routes.json`, `inventory.json`, `production_schedule.json`.
- **Events:** `simulate` and `run-service` write date-partitioned JSONL under `data/events/` (e.g. `YYYY-MM-DD.jsonl`). `generate-history` writes `data/events/history.jsonl`.
- **Corruption meta:** `data/events/_meta/corruption_meta_log.jsonl` (for ETL quarantine verification).

Event types include SalesOrderCreated, ShipmentCreated, LoadCreated, DeliveryEvent, InvoiceCreated, PaymentReceived, ProductionJob*, PurchaseOrder*, and others; only entity IDs align with the 10 parts and 10 products above.

---

## Database (optional)

PostgreSQL is used by `run-service` for **resume** (current simulation time and tick count). Use your own schema and pipeline to load events from JSONL. See `.env.example` for DB credentials.

---

## Legacy Version

The previous single-product (DRONE-X1) version of the simulator is preserved on the **`legacy`** branch. Use this repo’s **`main`** branch for the 10-drone, live-API scenario described above.
